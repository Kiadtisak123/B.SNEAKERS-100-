<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | B.Sneakers</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e60023; --dark: #0a0a0a; --card-bg: #1a1a1a; --text: #f0f0f0; --border: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { background: var(--dark); color: var(--text); display: flex; min-height: 100vh; }
        
        aside { width: 260px; background: #000; border-right: 1px solid var(--border); padding: 20px; position: fixed; height: 100%; z-index: 1000; }
        .logo { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 40px; text-align: center; text-decoration: none; display: block; }
        .logo span { color: var(--primary); }
        .menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #aaa; text-decoration: none; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: none; background: none; width: 100%; font-size: 16px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }
        
        main { margin-left: 260px; padding: 40px; width: calc(100% - 260px); }
        .section { display: none; }
        .section.active { display: block; }

        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary); }

        .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #222; padding: 15px; text-align: left; color: #888; font-size: 13px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        
        .badge { padding: 4px 10px; border-radius: 50px; font-size: 11px; font-weight: bold; }
        .status-pending { background: #f39c12; color: #000; }
        .status-paid { background: #2ecc71; color: #fff; }
        .status-shipping { background: #3498db; color: #fff; }
        .status-success { background: #9b59b6; color: #fff; }

        .btn { padding: 8px 12px; border-radius: 6px; cursor: pointer; border: none; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; color: white; text-decoration: none; }
        .btn-add { background: var(--primary); margin-bottom: 15px; }
        .btn-view { background: #3498db; }
        .btn-edit { background: #f39c12; }
        .btn-delete { color: #ff4d4d; background: rgba(255, 77, 77, 0.1); }
        .btn-delete:hover { background: #ff4d4d; color: white; }

        .img-preview { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; border: 1px solid #444; }
        .swal-img-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .img-unit { background: #222; padding: 8px; border-radius: 8px; text-align: left; font-size: 11px; color: #888; }
        .img-unit input { margin-top: 5px; width: 100%; }
        
        .order-info-grid { text-align: left; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .slip-img { width: 100%; border-radius: 8px; border: 1px solid #444; margin-top: 10px; cursor: pointer; transition: 0.3s; }
        .slip-img:hover { opacity: 0.8; }
    </style>
</head>
<body>

    <aside>
        <a href="index.html" class="logo">B.<span>SNEAKERS</span></a>
        
        <div class="menu-item active" onclick="switchTab('dash', this)"><i class="fas fa-chart-line"></i> แดชบอร์ด</div>
        <div class="menu-item" onclick="switchTab('stock', this)"><i class="fas fa-boxes-stacked"></i> สต็อกสินค้า</div>
        <div class="menu-item" onclick="switchTab('order', this)"><i class="fas fa-file-invoice-dollar"></i> ออเดอร์</div>
        <hr style="margin: 20px 0; opacity: 0.1; border: 0; border-top: 1px solid #fff;">
        
        <div class="menu-item" onclick="exportData()" style="color:#2ecc71;"><i class="fas fa-file-export"></i> สำรองข้อมูล</div>
        <a href="index.html" class="menu-item"><i class="fas fa-shop"></i> ไปหน้าบ้าน</a>
    </aside>

    <main>
        <section id="dash" class="section active">
            <h1>แดชบอร์ด</h1>
            <div class="stats-row">
                <div class="stat-card"><small>ยอดขายรวม</small><h2 id="totalSales">฿0</h2></div>
                <div class="stat-card"><small>ออเดอร์รอจัดส่ง</small><h2 id="newOrderCount">0</h2></div>
                <div class="stat-card"><small>สินค้าในสต็อก</small><h2 id="prodCount">0</h2></div>
            </div>
            <h3>รายการล่าสุด</h3>
            <div class="card">
                <table>
                    <thead><tr><th>รหัส</th><th>ลูกค้า</th><th>ยอด</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
                    <tbody id="recentOrderBody"></tbody>
                </table>
            </div>
        </section>

        <section id="stock" class="section">
            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 20px;">
                <h1>สต็อกสินค้า</h1>
                <button class="btn btn-add" onclick="addProduct()"><i class="fas fa-plus"></i> เพิ่มสินค้า</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>รูป</th><th>รุ่น / ไซส์</th><th>ราคา</th><th>สต็อก</th><th>จัดการ</th></tr></thead>
                    <tbody id="stockBody"></tbody>
                </table>
            </div>
        </section>

        <section id="order" class="section">
            <h1>จัดการออเดอร์</h1>
            <div class="card">
                <table>
                    <thead><tr><th>วันที่</th><th>รหัสออเดอร์</th><th>ลูกค้า</th><th>ยอดรวม</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
                    <tbody id="orderBody"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        let products = JSON.parse(localStorage.getItem('sneaker_prods')) || [];
        let orders = JSON.parse(localStorage.getItem('orders')) || [];

        function saveAll() {
            localStorage.setItem('sneaker_prods', JSON.stringify(products));
            localStorage.setItem('orders', JSON.stringify(orders));
            render();
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');
            render();
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'pending': return '<span class="badge status-pending">รอตรวจสอบ</span>';
                case 'paid': return '<span class="badge status-paid">จ่ายแล้ว/รอส่ง</span>';
                case 'shipping': return '<span class="badge status-shipping">กำลังส่ง</span>';
                case 'success': return '<span class="badge status-success">สำเร็จ</span>';
                default: return `<span class="badge">${status}</span>`;
            }
        }

        // ปรับปรุงการบีบอัดให้เล็กลงมากเพื่อประหยัดพื้นที่
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 500; // ลดขนาดความกว้างลงเหลือ 500px
                        let w = img.width, h = img.height;
                        if (w > maxW) { h *= maxW / w; w = maxW; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        // ปรับคุณภาพลงเหลือ 0.5 (50%) เพื่อให้เก็บรูปได้เยอะขึ้น
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    }
                }
            });
        }

        function render() {
            products = JSON.parse(localStorage.getItem('sneaker_prods')) || [];
            orders = JSON.parse(localStorage.getItem('orders')) || [];

            const revenue = orders.filter(o => ['paid','shipping','success'].includes(o.status)).reduce((s, o) => s + Number(o.total || 0), 0);
            document.getElementById('totalSales').innerText = `฿${revenue.toLocaleString()}`;
            document.getElementById('newOrderCount').innerText = orders.filter(o => o.status === 'paid').length;
            document.getElementById('prodCount').innerText = products.reduce((s,p) => s + Number(p.stock || 0), 0);

            document.getElementById('recentOrderBody').innerHTML = orders.slice(-5).reverse().map((o) => {
                const realIndex = orders.indexOf(o);
                return `
                <tr>
                    <td>#${o.orderID.slice(-5)}</td>
                    <td>${o.name}</td>
                    <td>฿${Number(o.total).toLocaleString()}</td>
                    <td>${getStatusBadge(o.status)}</td>
                    <td><button class="btn btn-view" onclick="viewOrderDetails(${realIndex})"><i class="fas fa-edit"></i></button></td>
                </tr>`;
            }).join('');

            document.getElementById('stockBody').innerHTML = products.map((p, i) => `
                <tr>
                    <td><img src="${p.images ? p.images[0] : (p.img || '')}" class="img-preview" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td><strong>${p.name}</strong><br><small>Size: ${p.sizes}</small></td>
                    <td>฿${Number(p.price).toLocaleString()}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editProduct(${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-delete" onclick="deleteItem(${i}, 'prod')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('orderBody').innerHTML = orders.slice().reverse().map((o, i) => {
                const idx = orders.length - 1 - i;
                return `
                <tr>
                    <td>${o.date || '-'}</td>
                    <td>#${o.orderID.slice(-8)}</td>
                    <td>${o.name}</td>
                    <td>฿${Number(o.total).toLocaleString()}</td>
                    <td>${getStatusBadge(o.status)}</td>
                    <td>
                        <button class="btn btn-view" onclick="viewOrderDetails(${idx})"><i class="fas fa-truck"></i> จัดการส่ง</button>
                        <button class="btn btn-delete" onclick="deleteItem(${idx}, 'order')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function addProduct() {
            const { value: res } = await Swal.fire({
                title: 'เพิ่มสินค้า (รองรับ 4 รูป)', background: '#1a1a1a', color: '#fff', confirmButtonColor: '#e60023',
                html: `
                    <input id="n" class="swal2-input" placeholder="ชื่อรุ่น">
                    <input id="p" type="number" class="swal2-input" placeholder="ราคา">
                    <input id="s" class="swal2-input" placeholder="ไซส์ (เช่น 38,39,40)">
                    <input id="q" type="number" class="swal2-input" placeholder="สต็อก">
                    <div class="swal-img-grid">
                        <div class="img-unit">รูป 1: <input id="f1" type="file" accept="image/*"></div>
                        <div class="img-unit">รูป 2: <input id="f2" type="file" accept="image/*"></div>
                        <div class="img-unit">รูป 3: <input id="f3" type="file" accept="image/*"></div>
                        <div class="img-unit">รูป 4: <input id="f4" type="file" accept="image/*"></div>
                    </div>
                `,
                preConfirm: async () => {
                    const name = document.getElementById('n').value;
                    if(!name) return Swal.showValidationMessage('กรุณาใส่ชื่อรุ่น');
                    
                    const imgs = [];
                    for(let k=1; k<=4; k++) {
                        const f = document.getElementById('f'+k).files[0];
                        if(f) imgs.push(await compressImage(f));
                    }
                    return { id: Date.now(), name, price: document.getElementById('p').value, sizes: document.getElementById('s').value, stock: Number(document.getElementById('q').value), images: imgs }
                }
            });
            if (res) { products.push(res); saveAll(); }
        }

        // ฟังก์ชันส่งออกข้อมูล ป้องกันข้อมูลหาย
        function exportData() {
            const data = { products, orders };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sneakers_backup_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        // ... ฟังก์ชันเดิม (viewOrderDetails, editProduct, deleteItem) ยังคงอยู่เหมือนเดิม ...
        async function editProduct(i) {
            const p = products[i];
            const { value: res } = await Swal.fire({
                title: 'แก้ไขสินค้า', background: '#1a1a1a', color: '#fff', confirmButtonColor: '#e60023',
                html: `<input id="n" class="swal2-input" value="${p.name}"><input id="p" type="number" class="swal2-input" value="${p.price}"><input id="s" class="swal2-input" value="${p.sizes}"><input id="q" type="number" class="swal2-input" value="${p.stock}">`,
                preConfirm: () => ({ ...p, name: document.getElementById('n').value, price: document.getElementById('p').value, sizes: document.getElementById('s').value, stock: Number(document.getElementById('q').value) })
            });
            if (res) { products[i] = res; saveAll(); }
        }

        function deleteItem(idx, type) {
            Swal.fire({
                title: 'ยืนยันการลบ?', icon: 'warning', showCancelButton: true,
                confirmButtonColor: '#d33', background: '#1a1a1a', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (type === 'prod') products.splice(idx, 1);
                    else orders.splice(idx, 1);
                    saveAll();
                }
            });
        }

        async function viewOrderDetails(index) {
            const o = orders[index];
            const itemsHtml = o.items.map(it => `<li>${it.name} (ไซส์ ${it.size}) x${it.qty}</li>`).join('');

            const { value: res } = await Swal.fire({
                title: `ออเดอร์ #${o.orderID.slice(-8)}`, width: '600px',
                background: '#1a1a1a', color: '#fff',
                html: `
                    <div class="order-info-grid">
                        <div style="grid-column: span 2; background:#222; padding:10px; border-radius:8px;">
                            <p><strong>ลูกค้า:</strong> ${o.name}</p>
                            <p><strong>ที่อยู่:</strong> ${o.address}</p>
                            <ul style="margin: 10px 0 0 20px; font-size:12px; color:#aaa;">${itemsHtml}</ul>
                        </div>
                        <div>
                            <label>สถานะ:</label>
                            <select id="s-status" class="swal2-input" style="width:100%;">
                                <option value="pending" ${o.status=='pending'?'selected':''}>รอตรวจสอบ</option>
                                <option value="paid" ${o.status=='paid'?'selected':''}>เตรียมส่ง</option>
                                <option value="shipping" ${o.status=='shipping'?'selected':''}>กำลังส่ง</option>
                                <option value="success" ${o.status=='success'?'selected':''}>สำเร็จ</option>
                            </select>
                        </div>
                        <div>
                            <label>เลขพัสดุ:</label>
                            <input id="s-track" class="swal2-input" value="${o.tracking || ''}">
                        </div>
                    </div>
                    ${o.slip ? `<img src="${o.slip}" class="slip-img" onclick="window.open(this.src)">` : ''}
                `,
                showCancelButton: true,
                confirmButtonText: 'อัปเดต',
                preConfirm: () => ({ status: document.getElementById('s-status').value, tracking: document.getElementById('s-track').value })
            });

            if (res) {
                orders[index] = { ...o, ...res };
                saveAll();
                Swal.fire('สำเร็จ', 'อัปเดตข้อมูลแล้ว', 'success');
            }
        }

        render();
    </script>
</body>
</html>
